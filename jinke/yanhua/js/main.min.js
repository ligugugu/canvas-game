var wNum=200;var hNum=50;var n=0;var textDataArr=[],inputTextArrSource=[];var textCanvas,textCtx,pixiCanvas;var pixiHeight=0;var isRun=true;var fwSpArr=[];var renderer,stage,home,fwCon;var spArr={};var burstArr=[];var launchArr=[];var launchScaleNum=.6;var fwSound;var shareid="";window.onload=function(){pageInit()};function pageInit(){fwSound=document.getElementById("fwSound");textCanvas=document.createElement("canvas");textCanvas.width=200;textCanvas.height=50;textCtx=textCanvas.getContext("2d");textCtx.font="30px 黑体 lighter";textCtx.strokeStyle="white";textCtx.fillStyle="white";pixiInit();$("#input_text").on("blur",function(e){inputText=$("#input_text").val();$("#input_text").val($.trim(inputText));var r=window.document.getElementById("input_text");checkWord(8,r)})}function pixiInit(){pixiCanvas=document.getElementById("pixiCanvas");pixiHeight=window.innerHeight>1040?window.innerHeight:1040;renderer=new PIXI.Application(640,pixiHeight,{view:pixiCanvas,preserveDrawingBuffer:true,transparent:true});console.log("adfasdfasdf");document.body.appendChild(renderer.view);home=new PIXI.Container;spArr.home=home;renderer.stage.addChild(home);share=new PIXI.Container;spArr.share=share;renderer.stage.addChild(share);share.visible=false;var e=new PIXI.loaders.Loader;for(var r=0;r<12;r++){e.add("fw_"+(r+1),"images/fw2/fw2_"+(r+1)+".png")}for(var r=0;r<12;r++){e.add("burst_"+(r+1),"images/burst/burst_"+(r+1)+".png")}for(var r=0;r<loadFlieData.length;r++){e.add(loadFlieData[r].name,loadFlieData[r].path)}e.on("progress",function(e,r){console.log("progress:",e.progress.toFixed(2)+"%");$("#loading_text").html(parseInt(e.progress)+"%")});e.once("complete",flieLoaded);e.load()}function flieLoaded(){TweenMax.to($("#loading"),1,{display:"none",opacity:0});for(var e=0;e<loadFlieData.length;e++){var r;if(loadFlieData[e].path==""){r=new PIXI.Sprite}else{r=new PIXI.Sprite.fromImage(loadFlieData[e].name)}r.anchor.set(.5);r.position.x=loadFlieData[e].x+r.width/2;r.position.y=loadFlieData[e].y+r.height/2;r.initX=r.x;r.initY=r.y;console.log(loadFlieData[e].parent);spArr[loadFlieData[e].parent].addChild(r);spArr[loadFlieData[e].name]=r}spArr.logo1.y+=(pixiHeight-1040)/2;spArr.bg0.y+=(pixiHeight-spArr.bg0.height)/2;spArr.bg0.height=pixiHeight;spArr.share_bg.y+=(pixiHeight-spArr.share_bg.height)/2;spArr.share_bg.height=pixiHeight;spArr.share_bg.alpha=.7;spArr.sharebtn.visible=false;spArr.replaybtn.visible=false;spArr.show_playbtn.visible=false;spArr.soundbtn.visible=false;spArr.soundicon_ae.visible=false;spArr.home_showbtn.visible=false;TweenMax.to(spArr.soundicon.scale,.3,{x:1.1,y:1.1,repeat:-1,yoyo:true,ease:Linear.easeNone});TweenMax.to(spArr.home_showbtnae.scale,.5,{x:1.1,y:1.1,repeat:-1,yoyo:true,ease:Linear.easeNone});TweenMax.to(spArr.home_showbtnt.scale,.5,{x:.9,y:.9,repeat:-1,yoyo:true,ease:Linear.easeNone});TweenMax.to(spArr.share_textae.scale,.5,{x:1.1,y:1.1,repeat:-1,yoyo:true,ease:Linear.easeNone});TweenMax.to(spArr.share_text.scale,.5,{x:.9,y:.9,repeat:-1,yoyo:true,ease:Linear.easeNone});TweenMax.to(spArr.share_jt,.5,{x:spArr.share_jt.x+20,y:spArr.share_jt.y-20,repeat:-1,yoyo:true,ease:Linear.easeNone});spArr.home_showbtn.interactive=true;spArr.sharebtn.interactive=true;spArr.replaybtn.interactive=true;spArr.show_playbtn.interactive=true;spArr.share_bg.interactive=true;spArr.soundbtn.interactive=true;spArr.soundbtn.isPlaying=true;spArr.home_showbtn.on("pointerdown",homeShowbtnClik);spArr.sharebtn.on("pointerdown",sharebtnClik);spArr.replaybtn.on("pointerdown",replaybtnClik);spArr.show_playbtn.on("pointerdown",shareHomebtnClik);spArr.share_bg.on("pointerdown",shareClik);spArr.soundbtn.on("pointerdown",soundbtnClik);fwCon=new PIXI.Container;fwCon.x=0;fwCon.y=0;home.addChild(fwCon);burstInit();launchInit();var t=1e3,a=0;logoData.map(function(e){e.y+=45;if(t>e.x){t=e.x}if(a<e.x){a=e.x}});console.log("min:",t,"max:",a);var n=(159-(a-t))/2;logoData.map(function(e){e.x+=n});shareid=urlObj.shareid;setTimeout(function(){if(shareid){inputText=decodeURIComponent(shareid);showDiyMovie()}else{drawText(text0Data);setTimeout(function(){TweenMax.to($("#home_inputbg"),1,{display:"block",opacity:1});spArr.home_showbtn.visible=true;spArr.home_showbtn.alpha=0;TweenMax.to(spArr.home_showbtn,1,{alpha:1,delay:.3});var e=pixiCanvas.toDataURL("image/png");var r=new Image;r.src=e;$(".bg").append(r)},1e3)}},1e3)}function soundbtnClik(e){if(spArr.soundbtn.isPlaying==true){spArr.soundbtn.isPlaying=false;spArr.soundicon.visible=false;spArr.soundicon_ae.visible=true;fwSound.pause()}else{spArr.soundbtn.isPlaying=true;spArr.soundicon.visible=true;spArr.soundicon_ae.visible=false;fwSound.play()}}function shareClik(e){share.visible=false}function sharebtnClik(e){MtaH5Click("home_sharebtn");share.visible=true}function replaybtnClik(e){MtaH5Click("home_replaybtn");window.location.href=urlObj.rootUrl+"?replay="+parseInt(Math.random()*1e4)}function shareHomebtnClik(e){MtaH5Click("share_homebtn");window.location.href=urlObj.rootUrl}function burstInit(){var e=12;var r=[];var t=[];for(var a=0;a<e;a++){r.push("images/burst/burst_"+(a+1)+".png")}for(var a=0;a<e;a++){var n=PIXI.Texture.fromImage(r[a]);t.push(n)}for(var a=0;a<7;a++){var o=new PIXI.extras.AnimatedSprite(t);o.animationSpeed=.2;o.anchor.set(.5);o.loop=false;o.id=a;var i=new PIXI.filters.ColorMatrixFilter;o.filters=[i];o.filter=i;o.onComplete=function(e){this.visible=false;if(this.id<3){launchMoviePlay(this.id)}};o.visible=false;burstArr.push(o);home.addChild(o)}}function launchInit(){var e=4;var r=[];var t=[];for(var a=0;a<e;a++){r.push("images/launch/launch_"+(a+1)+".png")}for(var a=0;a<e;a++){var n=PIXI.Texture.fromImage(r[a]);t.push(n)}for(var a=0;a<7;a++){var o=new PIXI.extras.AnimatedSprite(t);o.animationSpeed=.2;o.anchor.x=.5;o.x=Math.random()*440+100;o.y=-750;o.loop=true;o.gotoAndPlay(parseInt(Math.random()*e+1));launchArr.push(o);home.addChild(o)}}function launchMoviePlay(e,r){var t=launchArr[e];var a;if(e<3){t.x=Math.random()*540+50;t.y=750+Math.random()*100;t.sNum=Math.random()*launchScaleNum+.2;a=Math.random()*500+100;tweenTime=Math.random()+1}else{t.x=(e-3)*120+140;t.y=800;t.sNum=Math.random()*.5+.5;if(r){a=r}else{a=300}tweenTime=1}t.scale.set(t.sNum);t.visible=true;TweenMax.to(t,tweenTime,{y:a,onComplete:function(e){var r=burstArr[e];launchArr[e].visible=false;r.x=launchArr[e].x;r.y=launchArr[e].y;r.scale.set(launchArr[e].sNum);r.visible=true;r.gotoAndPlay(2);for(var e=0;e<3;e++){r.filter.matrix[e*6]=1+parseInt(Math.random()*400)/1e3}},onCompleteParams:[e]})}var inputText="",inputTextArr=[];function homeShowbtnClik(e){inputText=$("#input_text").val();console.log("inputText:",inputText);if(inputText.length==""){$("#input_text").val("");alert("请输入你的心愿(四字以内)")}else if(inputText.length>checkWordLength){$("#input_text").blur()}else{$("#input_text").blur();MtaH5Click("home_showbtn");spArr.home_showbtn.off("pointerdown");TweenMax.to($("#home_inputbg"),.5,{opacity:0});TweenMax.to(spArr.home_showbtn,.5,{alpha:0});setTimeout(function(){$("#home_inputbg").hide();spArr.home_showbtn.visible=false},1e3);shareDatas.lineLink=urlObj.rootUrl+"?shareid="+encodeURIComponent(inputText)+"&share=1";shareInit();showDiyMovie()}}function showDiyMovie(){MtaH5Click("movie_start");spArr.soundbtn.visible=true;fwSound.play();fireworksMovieEnd();for(var e=0;e<7;e++){setTimeout(function(e){launchMoviePlay(e,220)},e*200,e)}setTimeout(function(){drawText(text1Data)},2e3);setTimeout(function(){for(var e=3;e<7;e++){setTimeout(function(e){launchMoviePlay(e,320)},e*200,e)}},2500);setTimeout(function(){drawText(inputText)},4500);setTimeout(function(){for(var e=3;e<7;e++){setTimeout(function(e){launchMoviePlay(e,450)},e*200,e)}},5e3);setTimeout(function(){MtaH5Click("movie_end");var e=inputTextArrSource.concat(logoText3Data);drawText(logoData);if(shareid){spArr.show_playbtn.visible=true;spArr.show_playbtn.alpha=0;TweenMax.to(spArr.show_playbtn,.5,{alpha:1,delay:1});TweenMax.to(spArr.show_playbtnae.scale,.5,{x:1.1,y:1.1,repeat:-1,yoyo:true,ease:Linear.easeNone});TweenMax.to(spArr.show_playbtnt.scale,.5,{x:.9,y:.9,repeat:-1,yoyo:true,ease:Linear.easeNone})}else{spArr.sharebtn.visible=true;spArr.replaybtn.visible=true;spArr.sharebtn.alpha=0;spArr.replaybtn.alpha=0;spArr.sharebtn.x=spArr.sharebtn.x+100;spArr.replaybtn.x=spArr.replaybtn.x-100;TweenMax.to(spArr.sharebtn,.5,{x:spArr.sharebtn.initX,alpha:1,delay:1});TweenMax.to(spArr.replaybtn,.5,{x:spArr.replaybtn.initX,alpha:1,delay:1});setTimeout(function(){TweenMax.to(spArr.sharebtn.scale,.5,{x:.9,y:.9,repeat:-1,yoyo:true,ease:Linear.easeNone});TweenMax.to(spArr.replaybtn.scale,.5,{x:.9,y:.9,repeat:-1,yoyo:true,ease:Linear.easeNone})},1500)}},7e3)}function drawText(e){if(e){if(typeof e=="string"){inputTextArr=[];inputTextArrSource=[];textCtx.clearRect(0,0,wNum,hNum);textCtx.fillText(e,0,40);var r=textCtx.getImageData(0,0,wNum,hNum).data;var t=1e4,a=0;for(var o=0;o<hNum;o++){for(var i=0;i<wNum;i++){n=(o*wNum+i)*4;var s=r[n+3];if(r[n+3]>200){var l={};l.x=i;l.y=o;if(t>i){t=i}if(a<i){a=i}inputTextArr.push(l)}}}var p=(159-(a-t))/2;inputTextArr.map(function(e){e.x+=p;inputTextArrSource.push({x:e.x,y:e.y})});console.log("00000",inputTextArr[1]);inputTextArr.map(function(e){e.y+=15});console.log("11111",inputTextArr[1]);console.log("22222",inputTextArrSource[1]);textDataArr=inputTextArr.concat()}else if(typeof e=="object"){textDataArr=e.concat()}fireworksInit()}else{console.log("textStr为空")}}function fireworksInit(){var e=[];var r=[];var t=12;for(var a=0;a<t;a++){r.push("images/fw2/fw2_"+(a+1)+".png")}var n=[];for(var a=0;a<t;a++){var o=PIXI.Texture.fromImage(r[a]);n.push(o)}console.log("textDataArr:",textDataArr.length);for(a=0;a<textDataArr.length;a++){var i=new PIXI.extras.AnimatedSprite(n);i.animationSpeed=parseInt(1.5*Math.random())/10+.1;i.position.x=textDataArr[a].x*4;i.position.y=textDataArr[a].y*4;i.anchor.x=.5;i.anchor.y=.5;i.rotation=Math.random()*Math.PI;i.scaleNum=.15+Math.random()*.6;i.scale.set(i.scaleNum);i.gotoAndPlay(parseInt(Math.random()*t)+1);fwSpArr.push(i);fwCon.addChild(i);i.alpha=0;TweenMax.to(i,.8,{alpha:1,delay:(Math.random()*1.5).toFixed(3),ease:Linear.easeNone})}fwCon.y=150}function fireworksMovieEnd(){for(var e=0;e<fwSpArr.length;e++){var r=fwSpArr[e];var t=(Math.random()*1).toFixed(3);TweenMax.to(r,.5,{alpha:0,delay:t,ease:Linear.easeNone,onComplete:function(e){fwCon.removeChild(fwSpArr[e]);fwSpArr[e].destroy({children:true,texture:true,baseTexture:true})},onCompleteParams:[e]})}}function animate(){for(i=0;i<textDataArr.length;i++){fwSpArr[i].x=fwSpArr[i].x+Number((Math.random()*1-.5).toFixed(2));fwSpArr[i].y=fwSpArr[i].y+Number((Math.random()*1-.5).toFixed(2))}requestAnimationFrame(animate)}var checkWordLength=0;function checkWord(e,r){checkWordLength=e;var t=r.value;var a=0;for(i=0;i<t.length&&a<=e;i++){if(t.charCodeAt(i)>0&&t.charCodeAt(i)<128)a++;else a+=2}if(a>e){r.value=t.substring(0,i-1);return false}else{return true}}function MtaH5Click(e){try{MtaH5.clickStat(e)}catch(e){console.log(e)}}function inputNumber(e){var r=$("#"+e).val();r=r.replace(/\D/g,"");$("#"+e).val(r)}function inputNumEn(e){var r=$("#"+e).val();r=r.replace(/[\W]/g,"");$("#"+e).val(r)}function UrlSearch(){var e,r;var t=location.href;var a=t.indexOf("?");if(a>0){this["rootUrl"]=t.substr(0,a)}else{this["rootUrl"]=t}var n=t.lastIndexOf("/");this["rootPath"]=t.substr(0,n+1);t=t.substr(a+1);var o=t.split("&");for(var i=0;i<o.length;i++){a=o[i].indexOf("=");if(a>0){e=o[i].substring(0,a);r=o[i].substr(a+1);this[e]=r}}}